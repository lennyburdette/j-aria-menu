<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=8" />
	<title>Index</title>
	<link rel="stylesheet" href="css/global.css" type="text/css" media="screen" />
</head>
<body>
	<h1>Accessible, Deeply Nested Navigation</h1>
	
	<ul id="nav">
		<% 10.times do |i| %>
		<li id="section_<%= i %>"><a href="/?section=<%= i %>">Section <%= i %></a></li>
		<% end %>
	</ul>
	
	<form action="#" method="get" accept-charset="utf-8">
		<input type="text" name="some_name" value="" id="some_name" />
		<input type="submit" value="Submit" />
	</form>
	
	<script src="js/application.js" type="text/javascript"></script>
	<script type="text/javascript" charset="utf-8">
		$(function() {

			var idRegExp = /_(\d+)$/,
				empty = new Array(10),

				sectionLinks = $("#nav > li a"),
				lists = [];

			sectionLinks.bind("mouseover focus", initMenuItem);
			sectionLinks.attr("tabindex", -1).eq(0).attr("tabindex", 0);
			var previouslyFocusable = sectionLinks.eq(0);
			
			function appendSectionList(item) {
				if (item.data("init") || ! item.length) {
					return false;
				}
				item.data("init", true);
				
				var id = (item.attr("id").match(idRegExp) || empty)[1],
					sectionList = id ? $("#navSection_" + id) : false;

				if (sectionList.length) {
					item.append(sectionList);
					initList(sectionList);
				}
			};
			
			function initMenuItem(e) {
				appendSectionList($(this).parent());
				$(this).unbind("mouseover focus", initMenuItem);
			};
			
			sectionLinks.bind("focus", function() {
				STATE.current = $(this);
				STATE.level = MACHINE.top;
				changeFocusable($(this));
			});
			
			function changeFocusable(el) {
				previouslyFocusable.attr("tabindex", -1);
				el.attr("tabindex", 0);
				previouslyFocusable = el;
			};
			
			function initList(list) {
				list.find("> li > a").bind("focus", function() {
					STATE.current = $(this);
					STATE.level = MACHINE.firstlevel;
					changeFocusable($(this));
				});
				
				list.find("> li li a").bind("focus", function() {
					STATE.current = $(this);
					STATE.level = MACHINE.lowerlevel;
					changeFocusable($(this));
				});
				
				list.find("a").attr("tabindex", -1);
			};
			
			var keyboardRepeatInterval,
				cancelRepeat = false;;
			
			$("#nav").bind("keydown", function(e) {
				clearInterval(keyboardRepeatInterval);
				cancelRepeat = false;
				
				if (STATE.level && STATE.level.keydown[e.keyCode]) {
					var func = STATE.level[STATE.level.keydown[e.keyCode]];
					func(STATE.current);
					
					// keyboardRepeatInterval = setInterval(function() {
					// 	if (! cancelRepeat) {
					// 		func(STATE.current);
					// 		keyboardRepeatInterval = setInterval(function() {
					// 			if (! cancelRepeat) {
					// 				func(STATE.current);
					// 			}
					// 		}, 50);
					// 	}
					// }, 250);
				}
			});
			
			$(document).bind("keyup", function() {
				cancelRepeat = true;
				clearInterval(keyboardRepeatInterval);
			});
			
			var STATE = {
				current : null,
				level : null
			};
			
			var MACHINE = {
				top : {
					keydown : {
						37 : "previous", // left
						39 : "next", // right
						40 : "open", // down
						27 : "blur" // esc
					},
					
					previous : function(item) {
						item.parent().circularPrev("li").find("> a").focus();
					},
					
					next : function(item) {
						item.parent().circularNext("li").find("> a").focus();
					},
					
					open : function(item) {
						item.parent().find("> ul").show().find("> li:first-child > a").focus();
					},
					
					blur : function(item) {
						item.blur();
					}
				}
			};
			MACHINE.firstlevel = {
				keydown : {
					37 : "close", // left
					38 : "previous", // up
					39 : "open", // right
					40 : "next", // down
					27 : "up", // esc
					9 : "blur" // tab
				},
				
				close : function(item) {
					item.parent().parent().hide();
					var previousMenu = item.parents("#nav > li").circularPrev("li");
					appendSectionList(previousMenu);
					previousMenu.find("> ul").show().find("> li:first-child > a").focus();
				},
				
				previous : MACHINE.top.previous,
				
				open : MACHINE.top.open,
				
				next : MACHINE.top.next,
				
				up : function(item) {
					item.parent().parent().hide().parent().find("> a").focus();
				},
				
				blur : function(item) {
					item.parents("ul:not(#nav)").hide();
					changeFocusable(item.parents("#nav > li").find("> a"));
				}
			};
			MACHINE.lowerlevel = {
				keydown : {
					37 : "close", // left
					38 : "previous", // up
					39 : "open", // right
					40 : "next", // down
					27 : "up", // esc
					9 : "blur" // tab
				},
				
				close : function(item) {
					item.parent().parent().hide().parent().find("> a").focus();
				},
				
				previous : MACHINE.top.previous,
				
				open : function(item) {
					var list = item.parent().find("> ul");
					if (list.length) {
						list.show().find("> li:first-child > a").focus();
					} else {
						item.parents("ul:not(#nav)").hide();
						var nextMenu = item.parents("#nav > li").circularNext("li");
						appendSectionList(nextMenu);
						nextMenu.mouseover().find("> ul").show().find("> li:first-child > a").focus();
					}
				},
				
				next : MACHINE.top.next,
				
				up : MACHINE.firstlevel.up,
				
				blur : MACHINE.firstlevel.blur
			};
			
			$.fn.circularNext = function(pattern) {
				var el = $(this),
					next = el.next(pattern);
				
				if (! next.length) {
					next = el.parent().find("> " + pattern + ":first-child");
				}
				
				return next;
			};
			
			$.fn.circularPrev = function(pattern) {
				var el = $(this),
					prev = el.prev(pattern);
					
				if (! prev.length) {
					prev = el.parent().find("> " + pattern + ":last-child");
				}
				
				return prev;
			};

		});	
	</script>
	
	<div id="navItems">
		<% 10.times do |i| %>
		<ul id="navSection_<%= i %>" class="subsection">
			<% 10.times do |ii| %>
			<li>
				<a href="/?section=<%= i %>&amp;subsection=<%= ii %>">Subsection <%= ii %></a>
				<ul class="subsubsection">
				<% 10.times do |iii| %>
					<li>
						<a href="/?section=<%= i %>&amp;subsection=<%= ii %>&amp;subsubsection=<%= iii %>">Subsubsection <%= iii %></a>
					</li>
				<% end%>
				</ul>
			</li>
			<% end%>
		</ul>
		<% end%>
	</div>
</body>
</html>